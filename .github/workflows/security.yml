name: Security (Extended)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    # Run weekly on Monday at 7:00 UTC (after CodeQL at 6:30)
    - cron: '0 7 * * 1'

env:
  CARGO_TERM_COLOR: always

# Extended security checks (complements codeql.yml which has cargo-audit and Unicode checks)
jobs:
  # Check for license compliance and banned dependencies
  cargo-deny:
    name: License & Dependency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install cargo-deny
        run: |
          curl -fsSL https://github.com/cargo-bins/cargo-binstall/releases/latest/download/cargo-binstall-x86_64-unknown-linux-musl.tgz | tar xzf - -C /usr/local/bin
          cargo-binstall cargo-deny --no-confirm

      - name: Create deny.toml if not exists
        run: |
          if [ ! -f deny.toml ]; then
            cat > deny.toml << 'EOF'
          [advisories]
          db-path = "~/.cargo/advisory-db"
          db-urls = ["https://github.com/rustsec/advisory-db"]
          vulnerability = "warn"
          unmaintained = "warn"
          yanked = "warn"
          notice = "warn"

          [licenses]
          unlicensed = "warn"
          allow = [
            "MIT",
            "Apache-2.0",
            "Apache-2.0 WITH LLVM-exception",
            "BSD-2-Clause",
            "BSD-3-Clause",
            "ISC",
            "Zlib",
            "MPL-2.0",
            "Unicode-DFS-2016",
            "CC0-1.0",
            "BSL-1.0",
          ]
          confidence-threshold = 0.8

          [bans]
          multiple-versions = "warn"
          wildcards = "warn"
          highlight = "all"

          [sources]
          unknown-registry = "deny"
          unknown-git = "warn"
          allow-registry = ["https://github.com/rust-lang/crates.io-index"]
          EOF
          fi

      - name: Run cargo-deny
        run: cargo deny check 2>&1 | tee deny-output.txt || true

      - name: Upload deny results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cargo-deny-results
          path: deny-output.txt

  # Scan for hardcoded secrets and sensitive data
  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install gitleaks
        run: |
          curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.18.4/gitleaks_8.18.4_linux_x64.tar.gz | tar xzf - -C /usr/local/bin gitleaks

      - name: Run gitleaks
        run: |
          gitleaks detect --source . --verbose --redact 2>&1 | tee gitleaks-output.txt || true

          if grep -q "leaks found" gitleaks-output.txt; then
            echo "::error::Potential secrets detected in repository"
            exit 1
          fi
          echo "No secrets detected"

      - name: Upload gitleaks results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gitleaks-results
          path: gitleaks-output.txt

  # Static analysis for security patterns
  security-patterns:
    name: Security Pattern Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for unsafe code blocks
        run: |
          echo "=== Checking for unsafe code blocks ===" | tee security-patterns.txt
          grep -rn "unsafe\s*{" src/ --include="*.rs" >> security-patterns.txt 2>/dev/null || echo "No unsafe blocks found" >> security-patterns.txt
          echo "" >> security-patterns.txt

      - name: Check for potential command injection
        run: |
          echo "=== Checking for potential command injection ===" >> security-patterns.txt
          grep -rn "Command::new.*format!" src/ --include="*.rs" >> security-patterns.txt 2>/dev/null || echo "No obvious command injection patterns" >> security-patterns.txt
          echo "" >> security-patterns.txt

      - name: Check for hardcoded credentials patterns
        run: |
          echo "=== Checking for hardcoded credentials ===" >> security-patterns.txt
          grep -rniE "(password|secret|api_key|apikey|token)\s*=\s*[\"'][^\"']+[\"']" src/ --include="*.rs" >> security-patterns.txt 2>/dev/null || echo "No hardcoded credentials found" >> security-patterns.txt
          echo "" >> security-patterns.txt

      - name: Check for deprecated crypto
        run: |
          echo "=== Checking for deprecated crypto ===" >> security-patterns.txt
          grep -rniE "md5|sha1[^0-9]|des\s|rc4" src/ --include="*.rs" >> security-patterns.txt 2>/dev/null || echo "No deprecated crypto found" >> security-patterns.txt

      - name: Summary
        run: |
          echo ""
          echo "=== Security Pattern Analysis Summary ==="
          cat security-patterns.txt
          # Warn but don't fail - patterns need human review
          if grep -qE "unsafe|Command::new.*format!" security-patterns.txt; then
            echo "::warning::Security patterns detected that may need review"
          fi

      - name: Upload pattern analysis
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-patterns
          path: security-patterns.txt

  # Dependency supply chain check
  supply-chain:
    name: Supply Chain Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Cargo.lock exists
        run: |
          if [ ! -f Cargo.lock ]; then
            echo "::error::Cargo.lock is missing - dependencies are not pinned"
            exit 1
          fi
          echo "Cargo.lock exists - dependencies are pinned"

      - name: Check for git dependencies
        run: |
          echo "=== Supply Chain Analysis ===" | tee supply-chain.txt
          echo "" >> supply-chain.txt
          echo "Git dependencies:" >> supply-chain.txt
          grep -E "git\s*=" Cargo.toml >> supply-chain.txt 2>/dev/null || echo "  None" >> supply-chain.txt

          if grep -q "git\s*=" Cargo.toml; then
            echo "::warning::Git dependencies found - verify sources are trusted"
          fi

      - name: Check for path dependencies
        run: |
          echo "" >> supply-chain.txt
          echo "Path dependencies:" >> supply-chain.txt
          grep -E "path\s*=" Cargo.toml >> supply-chain.txt 2>/dev/null || echo "  None" >> supply-chain.txt

      - name: Check registry sources
        run: |
          echo "" >> supply-chain.txt
          echo "Custom registries:" >> supply-chain.txt
          if grep -E "registry\s*=" Cargo.toml 2>/dev/null; then
            echo "::warning::Custom registry detected - verify it's trusted"
            grep -E "registry\s*=" Cargo.toml >> supply-chain.txt
          else
            echo "  None (all from crates.io)" >> supply-chain.txt
          fi

      - name: Upload supply chain report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: supply-chain-report
          path: supply-chain.txt
