name: Security

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    # Run weekly on Monday at 6:00 UTC
    - cron: '0 6 * * 1'

env:
  CARGO_TERM_COLOR: always

jobs:
  # Audit dependencies for known vulnerabilities
  cargo-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install cargo-audit
        run: |
          curl -fsSL https://github.com/cargo-bins/cargo-binstall/releases/latest/download/cargo-binstall-x86_64-unknown-linux-musl.tgz | tar xzf - -C /usr/local/bin
          cargo-binstall cargo-audit --no-confirm

      - name: Run cargo-audit
        run: |
          cargo audit --json > audit-results.json || true
          cargo audit 2>&1 | tee audit-output.txt

          # Check for critical/high vulnerabilities
          if grep -q "RUSTSEC-" audit-output.txt; then
            echo "::warning::Security advisories found in dependencies"
            cat audit-output.txt
          fi

          # Fail on critical vulnerabilities
          if grep -qE "Severity: critical|Severity: high" audit-output.txt; then
            echo "::error::Critical or high severity vulnerabilities found"
            exit 1
          fi
          echo "No critical vulnerabilities found"

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cargo-audit-results
          path: |
            audit-results.json
            audit-output.txt

  # Check for license compliance and banned dependencies
  cargo-deny:
    name: License & Dependency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install cargo-deny
        run: |
          curl -fsSL https://github.com/cargo-bins/cargo-binstall/releases/latest/download/cargo-binstall-x86_64-unknown-linux-musl.tgz | tar xzf - -C /usr/local/bin
          cargo-binstall cargo-deny --no-confirm

      - name: Create deny.toml if not exists
        run: |
          if [ ! -f deny.toml ]; then
            cat > deny.toml << 'EOF'
          [advisories]
          db-path = "~/.cargo/advisory-db"
          db-urls = ["https://github.com/rustsec/advisory-db"]
          vulnerability = "warn"
          unmaintained = "warn"
          yanked = "warn"
          notice = "warn"

          [licenses]
          unlicensed = "warn"
          allow = [
            "MIT",
            "Apache-2.0",
            "Apache-2.0 WITH LLVM-exception",
            "BSD-2-Clause",
            "BSD-3-Clause",
            "ISC",
            "Zlib",
            "MPL-2.0",
            "Unicode-DFS-2016",
            "CC0-1.0",
            "BSL-1.0",
          ]
          confidence-threshold = 0.8

          [bans]
          multiple-versions = "warn"
          wildcards = "warn"
          highlight = "all"
          # Banned crates (known vulnerable or problematic)
          deny = [
            # Example: { name = "openssl", wrappers = ["openssl-sys"] }
          ]

          [sources]
          unknown-registry = "deny"
          unknown-git = "warn"
          allow-registry = ["https://github.com/rust-lang/crates.io-index"]
          EOF
          fi

      - name: Run cargo-deny
        run: cargo deny check 2>&1 | tee deny-output.txt || true

      - name: Upload deny results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cargo-deny-results
          path: deny-output.txt

  # Scan for hardcoded secrets and sensitive data
  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install gitleaks
        run: |
          curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.18.4/gitleaks_8.18.4_linux_x64.tar.gz | tar xzf - -C /usr/local/bin gitleaks

      - name: Run gitleaks
        run: |
          gitleaks detect --source . --verbose --redact 2>&1 | tee gitleaks-output.txt || true

          if grep -q "leaks found" gitleaks-output.txt; then
            echo "::error::Potential secrets detected in repository"
            exit 1
          fi
          echo "No secrets detected"

      - name: Upload gitleaks results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gitleaks-results
          path: gitleaks-output.txt

  # Static analysis for security patterns
  security-patterns:
    name: Security Pattern Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for unsafe code blocks
        run: |
          echo "=== Checking for unsafe code blocks ===" | tee security-patterns.txt
          grep -rn "unsafe\s*{" src/ --include="*.rs" >> security-patterns.txt 2>/dev/null || echo "No unsafe blocks found" >> security-patterns.txt

          UNSAFE_COUNT=$(grep -c "unsafe\s*{" src/**/*.rs 2>/dev/null || echo "0")
          echo "Found $UNSAFE_COUNT unsafe blocks" >> security-patterns.txt

      - name: Check for potential command injection
        run: |
          echo "" >> security-patterns.txt
          echo "=== Checking for potential command injection ===" >> security-patterns.txt
          # Look for Command::new with string interpolation
          grep -rn "Command::new.*format!" src/ --include="*.rs" >> security-patterns.txt 2>/dev/null || echo "No obvious command injection patterns" >> security-patterns.txt

      - name: Check for hardcoded credentials patterns
        run: |
          echo "" >> security-patterns.txt
          echo "=== Checking for hardcoded credentials ===" >> security-patterns.txt
          grep -rniE "(password|secret|api_key|apikey|token)\s*=\s*[\"'][^\"']+[\"']" src/ --include="*.rs" >> security-patterns.txt 2>/dev/null || echo "No hardcoded credentials found" >> security-patterns.txt

      - name: Check for SQL query construction
        run: |
          echo "" >> security-patterns.txt
          echo "=== Checking for dynamic SQL construction ===" >> security-patterns.txt
          grep -rn "format!.*SELECT\|format!.*INSERT\|format!.*UPDATE\|format!.*DELETE" src/ --include="*.rs" >> security-patterns.txt 2>/dev/null || echo "No obvious SQL injection patterns" >> security-patterns.txt

      - name: Check for path traversal patterns
        run: |
          echo "" >> security-patterns.txt
          echo "=== Checking for path traversal risks ===" >> security-patterns.txt
          grep -rn "\.\./" src/ --include="*.rs" >> security-patterns.txt 2>/dev/null || echo "No path traversal patterns" >> security-patterns.txt

      - name: Check for deprecated crypto
        run: |
          echo "" >> security-patterns.txt
          echo "=== Checking for deprecated crypto ===" >> security-patterns.txt
          grep -rniE "md5|sha1[^0-9]|des\s|rc4" src/ --include="*.rs" >> security-patterns.txt 2>/dev/null || echo "No deprecated crypto found" >> security-patterns.txt

      - name: Check for eval/exec patterns
        run: |
          echo "" >> security-patterns.txt
          echo "=== Checking for dynamic code execution ===" >> security-patterns.txt
          grep -rn "eval\|exec\|compile" src/ --include="*.rs" >> security-patterns.txt 2>/dev/null || echo "No eval/exec patterns" >> security-patterns.txt

      - name: Summary
        run: |
          echo ""
          echo "=== Security Pattern Analysis Summary ==="
          cat security-patterns.txt

          # Warn but don't fail - patterns need human review
          if grep -qE "unsafe|Command::new.*format!|password.*=.*[\"']" security-patterns.txt; then
            echo "::warning::Security patterns detected that may need review"
          fi

      - name: Upload pattern analysis
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-patterns
          path: security-patterns.txt

  # Check for suspicious Unicode characters (Trojan Source attack)
  unicode-check:
    name: Unicode Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for suspicious Unicode
        run: |
          echo "Checking for Trojan Source attack patterns..."

          # Check for bidirectional text control characters
          if grep -rP "[\x{200B}-\x{200F}\x{202A}-\x{202E}\x{2066}-\x{2069}]" src/ --include="*.rs" 2>/dev/null; then
            echo "::error::Suspicious Unicode control characters detected (potential Trojan Source attack)"
            exit 1
          fi

          # Check for homoglyph attacks in identifiers
          if grep -rP "[αβγδεАВСЕНКМОРТХ]" src/ --include="*.rs" 2>/dev/null; then
            echo "::warning::Potential homoglyph characters detected"
          fi

          echo "No suspicious Unicode patterns found"

  # Dependency supply chain check
  supply-chain:
    name: Supply Chain Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Cargo.lock exists
        run: |
          if [ ! -f Cargo.lock ]; then
            echo "::error::Cargo.lock is missing - dependencies are not pinned"
            exit 1
          fi
          echo "Cargo.lock exists - dependencies are pinned"

      - name: Check for git dependencies
        run: |
          echo "=== Checking for git dependencies ===" | tee supply-chain.txt
          grep -E "git\s*=" Cargo.toml >> supply-chain.txt 2>/dev/null || echo "No git dependencies" >> supply-chain.txt

          if grep -q "git\s*=" Cargo.toml; then
            echo "::warning::Git dependencies found - verify sources are trusted"
          fi

      - name: Check for path dependencies
        run: |
          echo "" >> supply-chain.txt
          echo "=== Checking for path dependencies ===" >> supply-chain.txt
          grep -E "path\s*=" Cargo.toml >> supply-chain.txt 2>/dev/null || echo "No path dependencies" >> supply-chain.txt

      - name: Verify registry sources
        run: |
          echo "" >> supply-chain.txt
          echo "=== Checking registry sources ===" >> supply-chain.txt

          # Check if any dependencies come from non-standard registries
          if grep -E "registry\s*=" Cargo.toml; then
            echo "::warning::Custom registry detected - verify it's trusted"
            grep -E "registry\s*=" Cargo.toml >> supply-chain.txt
          else
            echo "All dependencies from crates.io" >> supply-chain.txt
          fi

      - name: Upload supply chain report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: supply-chain-report
          path: supply-chain.txt

  # Final security summary
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [cargo-audit, cargo-deny, secrets-scan, security-patterns, unicode-check, supply-chain]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "=== Security Scan Summary ==="
          echo "cargo-audit: ${{ needs.cargo-audit.result }}"
          echo "cargo-deny: ${{ needs.cargo-deny.result }}"
          echo "secrets-scan: ${{ needs.secrets-scan.result }}"
          echo "security-patterns: ${{ needs.security-patterns.result }}"
          echo "unicode-check: ${{ needs.unicode-check.result }}"
          echo "supply-chain: ${{ needs.supply-chain.result }}"

          # Fail if any critical check failed
          if [ "${{ needs.secrets-scan.result }}" == "failure" ]; then
            echo "::error::Secrets detected - PR cannot be merged"
            exit 1
          fi

          if [ "${{ needs.unicode-check.result }}" == "failure" ]; then
            echo "::error::Trojan source attack pattern detected - PR cannot be merged"
            exit 1
          fi

          echo "Security checks completed"
